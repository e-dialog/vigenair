<!--
Copyright 2024 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

      https://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<mat-toolbar color="primary" class="sticky">
  <span style="margin-right: auto">
    <span style="font-size: 1.5em; display: flex; align-items: center">
      <img
        src="https://services.google.com/fh/files/misc/vigenair_logo.png"
        width="40px"
      />
      <span style="margin-left: 12px">ViGenAiR</span>
    </span></span
  >
  <span class="header-text">
    <a
      target="_blank"
      href="https://e-dialog.group/"
      >Recrafting Video Ads with Generative AI powered by e-dialog</a
    ></span
  >
  <span style="margin-left: auto"></span>
  <span #renderQueueButtonSpan>
    <button
      mat-icon-button
      matTooltip="Render queue"
      [matBadge]="renderQueue.length"
      [matBadgeHidden]="renderQueue.length === 0"
      matBadgeColor="accent"
      matBadgeSize="small"
      (click)="toggleRenderQueueSidenav()"
    >
      <mat-icon fontIcon="queue_play_next">
        <span class="cdk-visually-hidden">
          Render queue with overlaid badge showing the number
          {{ renderQueue.length }}
        </span>
      </mat-icon>
    </button>
  </span>
</mat-toolbar>
<div [hidden]="!loading" class="sticky" style="top: 64px">
  <mat-progress-bar mode="indeterminate"></mat-progress-bar>
</div>
<mat-sidenav-container style="height: calc(100% - 68px)">
  <mat-sidenav-content>
    <mat-expansion-panel #videoUploadPanel expanded>
      <mat-expansion-panel-header>
        <mat-panel-title class="panel-title"
          ><mat-icon class="panel-icon">video_library</mat-icon>Video
          selection</mat-panel-title
        >
      </mat-expansion-panel-header>
      <file-chooser
        class="file-chooser"
        (file)="onFileSelected($event)"
      ></file-chooser>
      <mat-checkbox
        matTooltip="Uncheck for videos where there is no voice-over"
        style="
          justify-content: center;
          display: flex;
          margin-top: 4px;
          margin-right: 15px;
        "
        color="primary"
        [(ngModel)]="analyseAudio"
        [disabled]="!selectedFile || loading"
      >
        Analyse voice-over
      </mat-checkbox>
      <button
        type="button"
        mat-raised-button
        color="primary"
        style="margin: auto; margin-top: 4px; display: block"
        [disabled]="!selectedFile || loading"
        (click)="uploadVideo()"
      >
        <mat-icon>upload</mat-icon>Upload video
      </button>
      <mat-slide-toggle
        #videosFilterToggle="matSlideToggle"
        color="primary"
        style="display: block; margin-bottom: 10px"
        *ngIf="previousRuns && previousRuns.length > 0"
        [checked]="false"
        [disabled]="loading"
        >My videos only</mat-slide-toggle
      >
      <mat-form-field
        style="width: 300px"
        subscriptSizing="dynamic"
        *ngIf="previousRuns && previousRuns.length > 0"
      >
        <mat-label>Load existing video</mat-label>
        <mat-select
          (selectionChange)="loadPreviousRun($event.value)"
          [disabled]="loading"
          (click)="getPreviousRuns()"
        >
          @for (run of previousRuns; track $index) {
            <mat-option *ngIf="isCurrentUserRun(run)" [value]="run"
              >{{ run.split('--')[0]
              }}{{
                run.split('--').length === 4 && run.split('--')[1] === 'n'
                  ? ' (no voice-over)'
                  : ''
              }}</mat-option
            >
          }
        </mat-select>
      </mat-form-field>
    </mat-expansion-panel>

    <mat-expansion-panel #videoMagicPanel>
      <mat-expansion-panel-header>
        <mat-panel-title class="panel-title"
          ><mat-icon class="panel-icon">auto_fix_high</mat-icon
          ><span style="margin-top: 4px">Video editing</span></mat-panel-title
        >
        <mat-panel-description>
          <a
            *ngIf="folderGcsPath"
            [href]="folderGcsPath"
            target="_blank"
            (click)="$event.stopPropagation()"
            matTooltip="Open GCS video folder"
            ><mat-icon color="primary">link</mat-icon></a
          >
        </mat-panel-description>
      </mat-expansion-panel-header>
      <div class="row">
        <div style="margin-right: auto">
          <mat-slide-toggle
            #reorderSegmentsToggle="matSlideToggle"
            color="primary"
            style="display: block"
            *ngIf="variants?.length"
            [checked]="false"
            matTooltip="Switch off to restore original segment order"
            (change)="restoreSegmentOrder()"
            >Reorder segments</mat-slide-toggle
          >
        </div>
        <div [style.margin-left]="variants?.length ? '330px' : '485px'">
          <mat-button-toggle-group
            #segmentModeToggle="matButtonToggleGroup"
            value="preview"
            [disabled]="loading && !generatingVariants"
            hideSingleSelectionIndicator="true"
          >
            <mat-button-toggle value="preview" matTooltip="Video preview">
              <mat-icon>play_arrow</mat-icon>
            </mat-button-toggle>
            <mat-button-toggle value="segments" matTooltip="Segments info">
              <mat-icon>theaters</mat-icon>
            </mat-button-toggle>
          </mat-button-toggle-group>
        </div>
        <div style="margin-left: auto">
          <mat-button-toggle-group
            #previewToggleGroup="matButtonToggleGroup"
            value="toggle"
            [disabled]="!videoObjects || segmentModeToggle.value !== 'preview'"
            hideSingleSelectionIndicator="true"
            (click)="loadPreview()"
          >
            <mat-button-toggle
              value="toggle"
              [matTooltip]="
                displayObjectTracking ? 'Object tracking' : 'Preview off'
              "
            >
              <mat-icon
                >{{ displayObjectTracking ? 'select_all' : 'deselect' }}
              </mat-icon>
            </mat-button-toggle>
            <mat-button-toggle
              value="vertical"
              matTooltip="Vertical format"
              [disabled]="!verticalVideoObjects"
            >
              <mat-icon>smartphone</mat-icon>
            </mat-button-toggle>
            <mat-button-toggle
              value="square"
              matTooltip="Square format"
              [disabled]="!squareVideoObjects"
            >
              <mat-icon>slideshow</mat-icon>
            </mat-button-toggle>
            <mat-button-toggle
              value="settings"
              matTooltip="Settings dialog"
              [disabled]="!verticalVideoObjects && !squareVideoObjects"
            >
              <mat-icon>settings</mat-icon>
            </mat-button-toggle>
          </mat-button-toggle-group>
        </div>
      </div>
      <div class="preview-video-row">
        <segments-list
          [segmentList]="avSegments"
          [segmentMode]="segmentModeToggle.value"
          [allowSelection]="variants !== undefined"
          [draggable]="reorderSegmentsToggle?.checked ?? false"
          [currentSegmentId]="currentSegmentId || 0"
          (seekToSegmentEvent)="seekToSegment($event)"
        ></segments-list>
        <div
          [hidden]="segmentModeToggle.value !== 'preview'"
          class="video-container"
        >
          <video
            class="mat-elevation-z8"
            #previewVideoElem
            autoplay
            controls
            disablePictureInPicture
          >
            <source src="" />
            <track
              label="Voice-over"
              kind="subtitles"
              #previewTrackElem
              default
            />
          </video>
          <canvas #magicCanvas></canvas>
        </div>
      </div>
      <div class="row">
        <mat-chip-set>
          <mat-chip disableRipple [ngClass]="transcriptStatus">
            <mat-icon
              matChipAvatar
              fontIcon="{{ transcriptStatus }}"
            ></mat-icon>
            Transcribing voice-over
          </mat-chip>
          <mat-chip disableRipple [ngClass]="analysisStatus">
            <mat-icon matChipAvatar fontIcon="{{ analysisStatus }}"></mat-icon>
            Analysing video elements
          </mat-chip>
          <mat-chip disableRipple [ngClass]="segmentsStatus">
            <mat-icon matChipAvatar fontIcon="{{ segmentsStatus }}"></mat-icon>
            Analysing video segments
          </mat-chip>
          <mat-chip
            *ngIf="rendering"
            disableRipple
            [ngClass]="combinationStatus"
          >
            <mat-icon
              matChipAvatar
              fontIcon="{{ combinationStatus }}"
            ></mat-icon>
            Rendering video variants
          </mat-chip>
        </mat-chip-set>
      </div>
      <ng-container *ngIf="variants">
        <mat-divider></mat-divider>
        <mat-tab-group
          [(selectedIndex)]="selectedVariant"
          (selectedTabChange)="variantChanged()"
        >
          <mat-tab
            *ngFor="let variant of variants"
            label="{{ variant.title }} -- {{ variant.duration }}"
          >
            <video-combo [combo]="variant" displayMode="variant"></video-combo>
          </mat-tab>
        </mat-tab-group>
        <br />
        <div class="row">
          <button
            type="button"
            mat-raised-button
            color="primary"
            (click)="addToRenderQueue()"
          >
            <mat-icon>add_to_queue</mat-icon>Add to render queue
          </button>
        </div>
      </ng-container>
      <ng-container *ngIf="avSegments">
        <mat-divider></mat-divider>
        <div *ngIf="variants?.length">
          <span style="margin-top: 4px; margin-bottom: 8px; display: flex">
            <mat-icon>video_settings</mat-icon
            ><span style="font-size: 18px; margin-left: 8px; margin-top: 2px"
              >Variant rendering settings</span
            >
          </span>
          <div style="margin-top: 8px">
            <mat-form-field subscriptSizing="dynamic">
              <mat-label>Variant audio:</mat-label>
              <mat-select [(ngModel)]="audioSettings">
                <mat-option value="segment">Individual segments</mat-option>
                <span
                  matTooltip="Only available for videos with voice-over"
                  [matTooltipDisabled]="analyseAudio"
                >
                  <mat-option value="music" [disabled]="!analyseAudio"
                    >Overlay music only</mat-option
                  >
                </span>
                <mat-option value="continuous">Overlay all audio</mat-option>
              </mat-select>
            </mat-form-field>
          </div>
          <div class="user-settings" style="margin-top: 8px">
            <mat-checkbox color="primary" [(ngModel)]="demandGenAssets">
              Generate Demand Gen assets
            </mat-checkbox>
            <img
              class="demand-gen"
              src="//storage.googleapis.com/support-kms-prod/1jn04nExNejhtrTJy7qjEhsjiBkDci1r27Ga"
              alt="This icon represents Demand Gen, which generates demands and delivers business results on Google's most visual and entertaining surfaces."
              data-mime-type="image/svg+xml"
            />
          </div>
          <div class="user-settings">
            <mat-checkbox color="primary" [(ngModel)]="renderAllFormats">
              Render all formats
            </mat-checkbox>
            <span class="format-icons">
              <span class="format-icon"><mat-icon>computer</mat-icon></span>
              <span class="format-icon"><mat-icon>smartphone</mat-icon></span>
              <span class="format-icon"><mat-icon>slideshow</mat-icon></span>
            </span>
          </div>
        </div>
        <div class="row" style="gap: 16px">
          <div
            style="
              display: flex;
              flex-direction: column;
              margin-right: auto;
              flex: auto;
            "
          >
            <mat-form-field style="flex: 1" subscriptSizing="dynamic">
              <mat-label>What should your video variants be about?</mat-label>
              <textarea
                matInput
                [(ngModel)]="prompt"
                placeholder="e.g. 'Discovering new experiences'"
              ></textarea>
            </mat-form-field>
            <mat-checkbox
              style="align-self: flex-start"
              color="primary"
              [(ngModel)]="negativePrompt"
              matTooltip="Prevent the content listed above from being included in your video variants"
            >
              Exclude from video variants
            </mat-checkbox>
          </div>
          <div style="display: flex; flex-direction: column; margin-top: -50px">
            <div>
              <mat-label>Target duration:</mat-label>
              <mat-slider
                discrete
                showTickMarks
                [max]="math.round(previewVideoElem.duration)"
                [min]="step"
                [step]="step"
                [disabled]="loading"
              >
                <input matSliderThumb [(ngModel)]="duration" #durationSlider />
              </mat-slider>
            </div>
            <button
              type="button"
              mat-raised-button
              color="primary"
              (click)="generateVariants()"
              [disabled]="loading"
            >
              <mat-icon>auto_awesome</mat-icon>Generate variants
            </button>
          </div>
        </div>
        <div class="row">
          <span class="notice-text"
            >Segments selected by the LLM might not follow prompt instructions,
            and the overall video variant might not follow the desired target
            duration. It is recommended to review and potentially modify the
            selection. Navigating between variants will clear any changes.
          </span>
        </div>
      </ng-container>
    </mat-expansion-panel>

    <mat-expansion-panel #videoCombosPanel [disabled]="!combosJson">
      <mat-expansion-panel-header>
        <mat-panel-title class="panel-title"
          ><mat-icon class="panel-icon">movie_filter</mat-icon>Rendered
          videos</mat-panel-title
        >
        <mat-panel-description>
          <a
            *ngIf="combos"
            href="{{ webAppUrl }}?inputCombosFolder={{ combosFolder }}"
            target="_blank"
            (click)="$event.stopPropagation()"
            matTooltip="Share rendered videos"
            ><mat-icon color="primary">share</mat-icon></a
          >
        </mat-panel-description>
      </mat-expansion-panel-header>
      <mat-tab-group>
        <mat-tab
          *ngFor="let combo of combos"
          label="{{ combo.title }} -- {{ combo.duration }}"
        >
          <video-combo [combo]="combo"></video-combo>
        </mat-tab>
      </mat-tab-group>
      <div
        *ngIf="!combos"
        style="
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
        "
      >
        <mat-spinner style="margin-bottom: 16px"></mat-spinner>
        Loading rendered videos
      </div>
    </mat-expansion-panel>
  </mat-sidenav-content>
  <mat-sidenav
    #renderQueueSidenav
    position="end"
    autoFocus="false"
    style="width: 35rem"
  >
    <div style="margin-bottom: auto">
      @for (variant of renderQueue; track variant; let i = $index) {
        <mat-card
          class="variant-row"
          matTooltip="Load variant"
          (click)="loadVariant(i)"
        >
          <div style="display: flex; flex-direction: column">
            <img
              class="variant-img"
              src="{{ variant.av_segments[0].segment_screenshot_uri }}"
            />
            <div style="display: flex; flex-direction: row">
              <span
                *ngIf="variant.render_settings.render_all_formats"
                class="render-queue-format-icons"
                matTooltip="Render all formats"
              >
                <span class="format-icon"><mat-icon>computer</mat-icon></span>
                <span class="format-icon"><mat-icon>smartphone</mat-icon></span>
                <span class="format-icon"><mat-icon>slideshow</mat-icon></span>
              </span>
              <span
                *ngIf="
                  variant.render_settings.generate_image_assets &&
                  variant.render_settings.generate_text_assets
                "
                style="margin-left: auto; margin-top: 9px; margin-right: 8px"
                matTooltip="Generate Demand Gen assets"
              >
                <img
                  width="25"
                  height="25"
                  src="//storage.googleapis.com/support-kms-prod/1jn04nExNejhtrTJy7qjEhsjiBkDci1r27Ga"
                  alt="This icon represents Demand Gen, which generates demands and delivers business results on Google's most visual and entertaining surfaces."
                  data-mime-type="image/svg+xml"
                />
              </span>
            </div>
          </div>
          <div>
            <div
              class="variant-score{{
                variant.userSelection ? '-modified' : ''
              }}"
              matTooltip="Score: {{ variant.score }}{{
                variant.userSelection ? ' (modified)' : ''
              }}"
            >
              @for (_ of stars; track _; let i = $index) {
                <mat-icon
                  fontIcon="{{
                    i + 1 <= variant.score ? 'star' : 'star_outlined'
                  }}"
                >
                  <span class="cdk-visually-hidden"
                    >1
                    {{ i + 1 <= variant.score ? 'full' : 'empty' }} star</span
                  >
                </mat-icon>
              }
            </div>
            <div class="variant-title">
              {{ variant.title }}
              <span *ngIf="variant.userSelection">(modified)</span>
            </div>
            <div class="variant-segments">
              <b>Segments:</b> {{ variant.scenes }}
            </div>
            <div class="variant-duration">
              <b>Duration:</b> {{ variant.duration }}
            </div>
            <div class="variant-settings">
              <b>Audio:</b>
              {{
                variant.render_settings.use_continuous_audio
                  ? 'Overlay all'
                  : variant.render_settings.use_music_overlay
                    ? 'Overlay music'
                    : 'Individual segments'
              }}
            </div>
          </div>
          <span class="variant-action-remove">
            <button
              mat-icon-button
              matTooltip="Remove"
              (click)="removeRenderQueueVariant($event, i)"
            >
              <mat-icon fontIcon="remove_from_queue">
                <span class="cdk-visually-hidden"
                  >Remove video variant from render queue</span
                >
              </mat-icon>
            </button>
          </span>
        </mat-card>
      }
    </div>
    <div class="row" style="flex-direction: column">
      <button
        type="button"
        mat-raised-button
        color="primary"
        (click)="renderVariants()"
      >
        <mat-icon>rocket_launch</mat-icon>Render
      </button>
      <br />
      <span class="notice-text"
        >Uploading a new video or selecting a previous one will clear the render
        queue.
      </span>
    </div>
  </mat-sidenav>
</mat-sidenav-container>
